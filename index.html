<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <title>Opentabs (Alpha)</title>
    <meta name="description" content="">
    <meta name="author" content="">

    <!--[if lt IE 9]>
        <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <link rel="stylesheet" href="stylesheets/base.css">
    <link rel="stylesheet" href="stylesheets/skeleton.css">
    <link rel="stylesheet" href="stylesheets/layout.css">

    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">

    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">

    <style>
        .gold    { background-color: #FFFF99; text-align: middle; width: 25px;}
        .blue    { background-color: #EEEEFF }
        .plus    { color: rgb(23, 136, 23) ; font-weight:bold; }
        .minus   { color: rgb(205, 23, 28) ; font-weight:bold; }
        .heading { font-weight:bold; }
        .hide    { display: none; }
        .note    { color: green; font-size: small; }
         table { border-collapse:separate; border-spacing: 0.5em 0em; }        
    </style>

</head>
<body>

<script src="http://code.jquery.com/jquery-1.6.4.min.js"></script>


    <div class="container">

        <div class="sixteen columns">
            <h1 class="remove-bottom" style="margin-top: 40px">Opentabs (Alpha)</h1>

            <h5 id="welcome">Loading...</h5>
            <hr />
        </div>
        <div class="one-third column">

          <ul class="tabs">
            <!-- Give href an ID value of corresponding "tabs-content" <li>'s -->
            <li><a class="active" href="#simple">My Tabs</a></li>

            <li><a href="#advanced">Advanced</a></li>
          </ul>

          <ul class="tabs-content">     
            <li id="simple" class="active">

              <form>
                  Send a new IOU to:
                  <br/>
                  <select name="payee" id="payee">
                      <option value="testdummy@opentabs.net">Test Dummy</option>
                  </select>        
                  <br/>      
                  Amount:
                  <br/>
                  <select name="amount" id="quantity">
                      <option value="1">1</option>
                      <option value="5" selected>5</option>
                      <option value="25">25</option>
                      <option value="100">100</option>
                      <option value="250">250</option>
                      <option value="1000">1000</option>
                  </select>              
                  <select name="currency" id="currency">
                      <option value="EUR">EUR</option>
                  </select>              
                  <input type="button" value="Send" id="save" />
              </form>
              
              <div id="opentabs"></div>
              <br/>
              <div class="plus" id="status"></div>
              <div class="note">Note: All test IOUs will be deleted 31 Jan 2012</div>

            <li id="advanced"><span class="heading">Login</span>
              <br/><br/>

              <button class="hide"id="clearall">Clear All IOUs</button>
              <form action="https://data.fm/rp_auth">
                &nbsp;(WebID) <a href="https://data.fm/login?next=http://opentabs.data.fm/"><img style="float: left" src="http://data.fm/common/images/loginWebID.png" /></a><br/><br/><br/>
              </form>
              <a href="https://data.fm/login?provider=Gmail&next=http://opentabs.data.fm/"><img src="http://ealltd.com/images/gmail%20logo.jpg" /></a><br/><br/>
              <a href="https://data.fm/login?provider=Yahoo&next=http://opentabs.data.fm/"><img src="http://www.textually.org/textually/archives/archives/images/set2/yahologo.gif" /></a>
              
              <br/><br/><a href="javascript:document.IOU.FBLogin()"><img src="http://www.getfitwatford.co.uk/images/stories/images/facebook_40.gif" /></a><br/><br/>
              
              <span class="heading">Add New Recipient</span><br/>
              <form>
                  Name : <input type="text" size="20" id="name" name="name" value="" /><br/>
                  Address : <input size="20" type="text" id="uri" name="uri" value="" /><br/>
                  <input type="button" value="Add" id="add" />
              </form>

              <a href="https://github.com/melvincarvalho/OpenTabs" rel="doap:homepage">Fork me on Github!</a>
              
              
            </li>
          </ul>

        </div>

    </div>

<script src="javascripts/tabs.js"></script>
<script src="javascripts/sha1.js"></script>
<script src="javascripts/jsonld.js"></script>
<script src="javascripts/jsonld-turtle.js"></script>
<script src="opentabs.js"></script>
<script>

(function($) {
  
  var IOU = function() { this.load() };
  IOU.prototype = {
    
    IOUs: [],
    friends: [],
    statuses: [],
  
    // Starting point
    load: function() {
      this.status('Loading user...', true);
      this.loadUser();
      this.render();
    },
    
    // Load user details, callback to displayUser
    loadUser: function() {
      // Non Facebook
      if (window.location.hash.length == 0) {
        var script = document.createElement('script');
        script.src = 'https://data.fm/user.js?callback=document.IOU.displayUser';
        document.body.appendChild(script);   
      // Facebook     
      } else {
        var accessToken = window.location.hash.substring(1);
        var path = "https://graph.facebook.com/me?";
        var queryParams = [accessToken, 'callback=document.IOU.displayUser'];
        var query = queryParams.join('&');
        var url = path + query;

        var script = document.createElement('script');
        script.src = url;
        document.body.appendChild(script);        
      }
    },
    
    // callback to loadFriends, calls loadRemote
    displayUser: function(user) {
      this.status('Loading user...', false);
      var userName = document.getElementById('welcome');
      if ( user.name ) {
        var greetingText = document.createTextNode('Greetings, ' + user.name + '.');
        window.user = 'https://graph.facebook.com/' + user.id;
        userName.innerHTML = 'Greetings, ' + user.name;
        this.loadFBFriends();
      } else {
        window.user = user; 
        var userName = document.getElementById('welcome');
        userName.innerHTML = 'User: ' + window.user;
      }
      this.loadRemote();
    },
    
    // callback to displayFriends
    loadFBFriends: function() {
      this.status('Loading friends...', true);
      var accessToken = window.location.hash.substring(1);
      var path = "https://graph.facebook.com/me/friends?";
      var queryParams = [accessToken, 'callback=document.IOU.displayFriends'];
      var query = queryParams.join('&');
      var url = path + query;

      // use jsonp to call the graph
      var script = document.createElement('script');
      script.src = url;
      document.body.appendChild(script);        
    },    

    displayFriends: function(data) {
      this.status('Loading friends...', false);
      var str;
      for (i=0; i<data['data'].length; i++) {
        var uri  = 'https://graph.facebook.com/' + data['data'][i].id;
        var name = data['data'][i].name;
        this.addFriend( uri, name );
      }
      this.render();
    },

    // called from add button
    addRecipient: function() {
      var uri  = this.makeURI($('#uri').val());
      var name = $('#name').val();
      
      this.addFriend( uri , name );
      this.saveRemote();
      
      alert( name + ' added!' );
      this.render();
    },

    // called from fb button
    FBLogin: function() {
      var appID = "119467988130777";
      if (window.location.hash.length == 0) {
        var path = 'https://www.facebook.com/dialog/oauth?';
        var queryParams = ['client_id=' + appID,
          'redirect_uri=' + window.location,
          'response_type=token'];
        var query = queryParams.join('&');
        var url = path + query;
        window.location = url;
      } else {
      }
    },

    loadRemote: function() {
      this.loadRemoteIOUs();
      this.loadRemoteFriends();      
    },
    
    loadRemoteFriends: function() {
      this.status('Loading friends...', true);
      
      // get user
      var user = window.user;
      if (!user) return;
      var userSha1 = hex_sha1(user);
      
      that = this;
      
      var baseDir = 'http://opentabs.data.fm/d/' + userSha1.substring(0,2) + '/' + userSha1.substring(2) + '/';
      

      $.getJSON(baseDir + 'private/friends.json' , function(data){
        for(var prop in data) {
          if(data.hasOwnProperty(prop)) {
            var name = data[prop]['http://xmlns.com/foaf/0.1/name'][0]['value'];
            var uri  = prop;
            document.IOU.addFriend(uri, name);
          }
        }
        
        that.render();
        that.status('Loading friends...', false);
      }).error(function(data){
        that.status('Loading friends...', false);
      });
            
    },
    
    loadRemoteIOUs: function() {
      this.status('Loading IOUs...', true);
      
      // get user
      var user = window.user;
      if (!user) return;
      var userSha1 = hex_sha1(user);
      
      that = this;
      
      var baseDir = 'http://opentabs.data.fm/d/' + userSha1.substring(0,2) + '/' + userSha1.substring(2) + '/';
      

      $.getJSON(baseDir + 'private/transfers.json' , function(data){
        
        document.IOU.IOUs = [];
        for(var prop in data) {
          if(data.hasOwnProperty(prop)) {
            var source = data[prop]['http://payswarm.com/vocabs/commerce#source'][0]['value'];
            var destination = data[prop]['http://payswarm.com/vocabs/commerce#destination'][0]['value'];
            var amount = data[prop]['http://payswarm.com/vocabs/commerce#amount'][0]['value'];
            var currency = data[prop]['http://payswarm.com/vocabs/commerce#currency'][0]['value'];
            var comment = data[prop]['http://www.w3.org/2000/01/rdf-schema#comment'][0]['value'];
            var date = data[prop]['http://purl.org/dc/terms/created'][0]['value'];
            document.IOU.IOUs.push(that.createIOU(source, destination, amount, currency, comment, date));
          }
        }
        that.render();
        that.status('Loading IOUs...', false);
      }).error(function(data){
        that.status('Loading IOUs...', false);
      });
            
    },
    
    save: function() {
      if( !this.confirm() ) {
        alert('Operation Cancelled');
        return;
      }
      
      this.saveLocal();
      this.saveRemote();
      this.syncRemote();
    },

    saveLocal: function() { 
      if (!this.IOUs) this.IOUs = [];
      this.IOUs.push(this.createIOU(window.user, this.makeURI($('#payee').val()), $('#quantity').val(), $('#currency').val(), 'test', new Date() ));
      window.localStorage.setItem('IOUs', JSON.stringify(this.IOUs));
    },

    saveRemote: function() {
      this.saveRemoteIOUs();
      this.saveRemoteFriends();
    },
    
    saveRemoteIOUs: function() {
      this.status('Saving IOUs...', true);
      // get user
      var user = window.user;
      var userSha1 = hex_sha1(user);

      // dirs
      var baseDir = 'http://opentabs.data.fm/d/' + userSha1.substring(0,2) + '/' + userSha1.substring(2) + '/';
      this.createDirectory(baseDir + 'public/');
      this.createDirectory(baseDir + 'private/');
      this.createDirectory(baseDir + 'friends/');


      // DELETE
      this.deleteFile(baseDir + 'private/transfers');      

      // PUT
      var body = jsonld.turtle(this.IOUs);
      this.putFile(baseDir + 'private/transfers', body);      
      this.status('Saving IOUs...', false);
    },
    
    saveRemoteFriends: function() {
      this.status('Saving friends...', true);
      // get user
      var user = window.user;
      var userSha1 = hex_sha1(user);

      // dirs
      var baseDir = 'http://opentabs.data.fm/d/' + userSha1.substring(0,2) + '/' + userSha1.substring(2) + '/';
      this.createDirectory(baseDir + 'public/');
      this.createDirectory(baseDir + 'private/');
      this.createDirectory(baseDir + 'friends/');


      // DELETE
      this.deleteFile(baseDir + 'private/friends');      

      // PUT
      var body = jsonld.turtle(this.friends);
      this.putFile(baseDir + 'private/friends', body);      
      this.status('Saving friends...', false);
    },
    
    
    
    syncRemote: function() {
      this.status('Saving IOUs...', true);
      // get user
      var user = this.makeURI($('#payee').val());
      var userSha1 = hex_sha1(user);
      var that = this;

      // dirs
      var baseDir = 'http://opentabs.data.fm/d/' + userSha1.substring(0,2) + '/' + userSha1.substring(2) + '/';
      this.createDirectory(baseDir + 'public/');
      this.createDirectory(baseDir + 'private/');
      this.createDirectory(baseDir + 'friends/');



      try {
        $.getJSON(baseDir + 'private/transfers' +'.json' , function(data){
          //alert(data);
          var IOUs = [];
          for(var prop in data) {
            if(data.hasOwnProperty(prop)) {
              var source = data[prop]['http://payswarm.com/vocabs/commerce#source'][0]['value'];
              var destination = data[prop]['http://payswarm.com/vocabs/commerce#destination'][0]['value'];
              var amount = data[prop]['http://payswarm.com/vocabs/commerce#amount'][0]['value'];
              var currency = data[prop]['http://payswarm.com/vocabs/commerce#currency'][0]['value'];
              var comment = data[prop]['http://www.w3.org/2000/01/rdf-schema#comment'][0]['value'];
              var date = data[prop]['http://purl.org/dc/terms/created'][0]['value'];
              IOUs.push(that.createIOU(source, destination, amount, currency, comment, date));
            }
          }


          IOUs.push(that.createIOU($('#payee').val(), window.user, -1.0*$('#quantity').val(), $('#currency').val(), 'test', new Date()));
        
          // DELETE
          that.deleteFile(baseDir + 'private/transfers');
      
          // PUT
          var body = jsonld.turtle(IOUs);
          that.putFile(baseDir + 'private/transfers', body);
        
        
          that.render();
          that.status('Saving IOUs...', false);
       
        }).error(function () {
          var IOUs = [];        
          IOUs.push(that.createIOU($('#payee').val(), window.user, -1.0*$('#quantity').val(), $('#currency').val(), 'test', new Date() ));
        
          // PUT
          var body = jsonld.turtle(IOUs);
          that.putFile(baseDir + 'private/transfers', body);
          
          that.status('Saving IOUs...', false);
          that.render();
          
        });
      } catch (err) {
        alert('could not sync');
      }
      
    },
    
    

    // render
    render: function() {
      that = this;
      this.populateFriendsDropdown();
      $('#opentabs').empty();
      if(!this.IOUs || !this.IOUs.length) {
        $('#opentabs').append( $('<p>').text('Currently no open tabs found.') );
        return;
      }
      
      var line = '<tr>' 
        line += '<td class="heading">My Tabs</td>';
        line += '<td></td>';
        line += '<td></td>';
        line += '</tr>';
      $('#opentabs').append( $('<table>').append(line) );
      
      this.IOUs.forEach(function(item) {
        if (item) {
          var source = item['http://payswarm.com/vocabs/commerce#source']['@id'];
          var dest = item['http://payswarm.com/vocabs/commerce#destination']['@id'];
          var amount = item['http://payswarm.com/vocabs/commerce#amount'];
          var curr = item['http://payswarm.com/vocabs/commerce#currency'];
          var created = item['http://purl.org/dc/terms/created'];
          var comment = item['http://www.w3.org/2000/01/rdf-schema#comment'];
          var line = '<tr>' 
          var pm = ((-1 * amount)<0)?'minus':'plus';
          
          line += '<td nowrap="nowrap" title="'+ dest +'">' + dest + '</td>';
          line += '<td title="'+ comment +'" class="gold '+ pm +'">' + (-1 * amount) + '</td>';
          line += '<td title="'+ created +'"><a href="javascript:document.IOU.toggle()">' + curr + '</a></td>';
          line += '</tr>';
          if ( $('td:contains("'+ dest +'")').length > 0 ) {
            var prev = $('td:contains("'+ dest +'")').first().next().html();
            var sum = 1.0*prev + (-1 * amount );
            pm = (sum<0)?'minus':'plus';
            var el = $('td:contains("'+ dest +'")').first();
            el.next().html(sum).removeClass('plus minus').addClass(pm);
            el.parent().after(line).next().addClass('blue').hide();
          } else {
            $('#opentabs table tr:last').after(line);
            $('#opentabs table tr:last').after(line).next().addClass('blue').hide();
          }
        }
      });
      
      
      this.beautify();      
      this.showSummary();
      
    },
    
    showSummary: function() {
      $('#advanced').removeClass('active');
      $('#simple').addClass('active');
      $('#simple').click();
      $('#advanced').hide();
      $('#simple').show();
    },
    
    populateFriendsDropdown: function() {
      // sort friends
      if (!this.friends) return;
      this.friends = this.friends.sort(function(a,b) { 
        if (a['http://xmlns.com/foaf/0.1/name'] > b['http://xmlns.com/foaf/0.1/name']) { 
          return 1;
        } else { 
          return -1; 
        }
      });
      $('#payee').children().remove().end();
      
      for (i=0; i<this.friends.length; i++) {
        var uri  = this.friends[i]['@id'];
        var name = this.friends[i]['http://xmlns.com/foaf/0.1/name'];
        $("#payee").append("<option value="+ uri +">"+ name +"</option>");
      }
    },      

    // Helpers
    confirm: function() {
      var IOU = 'You are about to send:\n\n'+ $('#payee').val()
      IOU += '\n\nan IOU for ' + $('#quantity').val() + ' ' + $("#currency").val();
      IOU += '\n\nAre you sure?  \n\n***All IOUs are currently TEST only***';
      return confirm(IOU);
    },

    toggle: function() {
      $('.blue').toggle('slide');
    },

    beautify: function() {
      // beautify cells
      //alert('changing cells');
      if ( !this.friends ) this.friends = [];
      that = this;
      $('td').each(function() { 
        var html = $(this).html();
        var n;
        //alert(JSON.stringify(that.friends));
        for (i=0; i<that.friends.length; i++) {
          if ( that.friends[i]['@id'] == html) {
            n = that.friends[i]['http://xmlns.com/foaf/0.1/name'];
            //alert(n);   
          }
        }
          
        if ( n ) {
          $(this).html(n);
        } else if ( html.substring(0,7) == 'mailto:' ) {
          $(this).html(html.substring(7));
        } else if ( $(this).text() == 'EUR' ) {
          $(this).children().text('€');
        }
      });

      //$('#welcome').html(window.user);
    },

    clear: function() {
      this.IOUs = window.localStorage.IOUs = null;
      this.saveRemote();
      this.load();
    },
    
    addFriend: function(uri, name) {
      for (i=0; i<this.friends.length; i++) {
        if ( uri == this.friends[i]['@id'] && name == this.friends[i]['http://xmlns.com/foaf/0.1/name'] ) return;
      }
      
      this.friends.push({ "@id" : uri, "http://xmlns.com/foaf/0.1/name" : name });
      window.localStorage.friends = JSON.stringify(this.friends);
    },
    
    deleteFile: function(file) {
      var body = '';
      xhr = new XMLHttpRequest();
      xhr.open('DELETE', file, false);
      xhr.setRequestHeader('Content-Type', 'text/turtle; charset=UTF-8');
      xhr.send(body);      
    },
    
    putFile: function(file, data) {
      xhr = new XMLHttpRequest();
      xhr.open('PUT', file, false);
      xhr.setRequestHeader('Content-Type', 'text/turtle; charset=UTF-8');
      xhr.send(data);   
    },
    
    createDirectory: function(dir) {
      var xhr = new XMLHttpRequest();
      xhr.open('MKCOL', dir, false);
      xhr.send();
    },

    status: function(message, add) {
      if (add) {
        this.statuses.push(message);
      } else {
        for (i=0; i<this.statuses.length; i++) {
          if (message == this.statuses[i]) {
            this.statuses.splice(i, 1);
          }
        }
      }
      if (this.statuses.length) {
        $('#status').html(this.statuses[0]);
      } else {
        $('#status').html('');
      }
    },

    
    createIOU: function(source, destination, amount, currency, comment, date) {
       
       var IOU = {
                     "@id": "",
                     "http://payswarm.com/vocabs/commerce#source": {
                         "@id": this.makeURI(source)
                      },
                      "http://payswarm.com/vocabs/commerce#destination": {
                          "@id": this.makeURI(destination)
                      },
                      "http://payswarm.com/vocabs/commerce#amount": amount,
                      "http://payswarm.com/vocabs/commerce#currency": currency,
                      "http://www.w3.org/2000/01/rdf-schema#comment": comment,
                      "http://purl.org/dc/terms/created": date,
                      "http://www.w3.org/1999/02/22-rdf-syntax-ns#type": {
                          "@id": "http://payswarm.com/vocabs/commerce#Transfer"
                       }
                   };
             
                   
      IOU['@id'] = '#' + hex_sha1(JSON.stringify(IOU));             

      return IOU;
    },
    
    makeURI: function(id) {
      if ( id.substring(0,7) == 'mailto:' ) {
        return id;
      } else if ( id.indexOf(':') != -1 ) {
        return id;
      } else {
        return 'mailto:' + id;
      }
    }
    
  };
  
  // Init
  $(document).ready(function() {
    document.IOU = new IOU; 
    $('#clearall').click(function() { document.IOU.clear() });
    $('#save').click(function() { document.IOU.save() });
    $('#add').click(function() { document.IOU.addRecipient() });
  });
  
})(jQuery);



</script>

</body>
</html>
